#!/usr/bin/env python3
import pprint
import requests

HOST_NAME="<%= @cmkserver %>"
SITE_NAME = "cmk"
API_URL = f"http://{HOST_NAME}:8080/{SITE_NAME}/check_mk/api/1.0"

USERNAME = "automation"
PASSWORD="<%= @apitoken %>"

session = requests.session()
session.headers['Authorization'] = f"Bearer {USERNAME} {PASSWORD}"
session.headers['Accept'] = 'application/json'

resp = session.post(
    f"{API_URL}/domain-types/host_config/collections/all",
    params={  # goes into query string
        "bake_agent": False,  # Tries to bake the agents for the just created hosts.
    },
    headers={
        "Content-Type": 'application/json',  # (required) A header specifying which type of content is in the request/response body.
    },
    json={
        'folder': '/',
        'host_name': '<%= @host_name %>',
        'attributes': {
            'ipaddress': '<%= @host_ip %>'
        }
    },
)
if resp.status_code == 200:
    pprint.pprint(resp.json())
elif resp.status_code == 204:
    print("Done")
else:
    raise RuntimeError(pprint.pformat(resp.json()))
